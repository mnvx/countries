<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive World Tax Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .control-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .switch-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .switch-container:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 15px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .switch-label {
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            user-select: none;
        }

        .green-switch input:checked + .slider {
            background-color: #4CAF50;
        }

        .blue-switch input:checked + .slider {
            background-color: #2196F3;
        }

        .map-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-type-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }

        .map-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.4);
        }

        .map-type-btn.active {
            background: linear-gradient(135deg, #2c3e50, #34495e);
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .legend {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .legend h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .legend-text {
            font-size: 12px;
            color: #2c3e50;
        }

        .country-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .country-info h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .country-info p {
            font-size: 12px;
            color: #555;
            margin: 3px 0;
        }

        .leaflet-popup-content {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .leaflet-popup-content h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .leaflet-popup-content p {
            margin: 5px 0;
            font-size: 13px;
        }

        .loading-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            color: #2c3e50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .status-hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>üåç Tax Map</h1>
            
            <div class="control-group">
                <h3>Tax Filters</h3>
                <div class="switch-container green-switch">
                    <label class="switch">
                        <input type="checkbox" id="noTaxSwitch">
                        <span class="slider"></span>
                    </label>
                    <label for="noTaxSwitch" class="switch-label">No World Taxes</label>
                </div>
                
                <div class="switch-container blue-switch">
                    <label class="switch">
                        <input type="checkbox" id="lowTaxSwitch">
                        <span class="slider"></span>
                    </label>
                    <label for="lowTaxSwitch" class="switch-label">Taxes Less Than 10%</label>
                </div>
            </div>

            <div class="control-group">
                <h3>Map Layers</h3>
                <div class="map-controls">
                    <button class="map-type-btn active" onclick="setMapType('regular')">Regular</button>
                    <button class="map-type-btn" onclick="setMapType('terrain')">Relief</button>
                    <button class="map-type-btn" onclick="setMapType('satellite')">Satellite</button>
                </div>
            </div>

            <div class="legend">
                <h4>Legend</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(76, 175, 80, 0.8);"></div>
                    <span class="legend-text">No World Taxes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(33, 150, 243, 0.8);"></div>
                    <span class="legend-text">Taxes Less Than 10%</span>
                </div>
            </div>

            <div class="country-info" id="countryInfo" style="display: none;">
                <h4>Country Details</h4>
                <div id="countryDetails"></div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="loadingStatus" class="loading-status">Loading country boundaries...</div>
            <div id="map"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Tax data for countries
        const countryData = [
            { country: 'AD', iso3: 'AND', name: 'Andorra', worldTaxes: 1, totalTaxes: 8.5, comments: 'For family: 0% for $40000, 10% for other' },
            { country: 'AE', iso3: 'ARE', name: 'United Arab Emirates', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'AG', iso3: 'ATG', name: 'Antigua and Barbuda', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'AM', iso3: 'ARM', name: 'Armenia', worldTaxes: 1, totalTaxes: 10, comments: '' },
            { country: 'BG', iso3: 'BGR', name: 'Bulgaria', worldTaxes: 1, totalTaxes: 10, comments: '10% for world incomes' },
            { country: 'BH', iso3: 'BHR', name: 'Bahrain', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'BN', iso3: 'BRN', name: 'Brunei Darussalam', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'BY', iso3: 'BLR', name: 'Belarus', worldTaxes: 1, totalTaxes: 6, comments: 'Individual enterpreneur' },
            { country: 'DM', iso3: 'DMA', name: 'Dominica', worldTaxes: 0, totalTaxes: 35, comments: '' },
            { country: 'GD', iso3: 'GRD', name: 'Grenada', worldTaxes: 0, totalTaxes: 28, comments: '' },
            { country: 'GE', iso3: 'GEO', name: 'Georgia', worldTaxes: 1, totalTaxes: 3, comments: 'Individual enterpreneur' },
            { country: 'KG', iso3: 'KGZ', name: 'Kyrgyzstan', worldTaxes: 1, totalTaxes: 2, comments: 'Individual enterpreneur, IT' },
            { country: 'KN', iso3: 'KNA', name: 'Saint Kitts and Nevis', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'KW', iso3: 'KWT', name: 'Kuwait', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'KY', iso3: 'CYM', name: 'Cayman Islands', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'KZ', iso3: 'KAZ', name: 'Kazakhstan', worldTaxes: 1, totalTaxes: 3, comments: 'Individual enterpreneur' },
            { country: 'LC', iso3: 'LCA', name: 'Saint Lucia', worldTaxes: 0, totalTaxes: 30, comments: '' },
            { country: 'MC', iso3: 'MCO', name: 'Monaco', worldTaxes: 25, totalTaxes: 0, comments: 'No taxes for companies who gain 75% of incomes inside of country. No taxes for residents.' },
            { country: 'PA', iso3: 'PAN', name: 'Panama', worldTaxes: 0, totalTaxes: 25, comments: '' },
            { country: 'PT', iso3: 'PRT', name: 'Portugal', worldTaxes: 0, totalTaxes: 30, comments: 'Progressive tax system, NHR program available' },
            { country: 'QA', iso3: 'QAT', name: 'Qatar', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'RU', iso3: 'RUS', name: 'Russia', worldTaxes: 1, totalTaxes: 6, comments: 'Individual enterpreneur s implified tax form' },
            { country: 'RS', iso3: 'SRB', name: 'Serbia', worldTaxes: 1, totalTaxes: 14, comments: 'Individual enterpreneur on lump sum system, IT' },
            { country: 'SA', iso3: 'SAU', name: 'Saudi Arabia', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'UZ', iso3: 'UZB', name: 'Uzbekistan', worldTaxes: 1, totalTaxes: 12, comments: 'Individual enterpreneur' },
            { country: 'VC', iso3: 'VCT', name: 'Saint Vincent and the Grenadines', worldTaxes: 0, totalTaxes: 0, comments: '' },
            { country: 'VG', iso3: 'VGB', name: 'British Virgin Islands', worldTaxes: 0, totalTaxes: 0, comments: 'No personal income tax' },
            { country: 'UY', iso3: 'URY', name: 'Uruguay', worldTaxes: 0, totalTaxes: 0, comments: 'Territorial principle' },
            // { country: 'US', iso3: 'USA', name: 'United States', worldTaxes: 1, totalTaxes: 37, comments: 'Worldwide taxation for citizens and residents' },
            // { country: 'SG', iso3: 'SGP', name: 'Singapore', worldTaxes: 0, totalTaxes: 22, comments: 'Territorial tax system' },
            // { country: 'HK', iso3: 'HKG', name: 'Hong Kong', worldTaxes: 0, totalTaxes: 17, comments: 'Territorial tax system' },
            // { country: 'CH', iso3: 'CHE', name: 'Switzerland', worldTaxes: 1, totalTaxes: 8.5, comments: 'Cantonal tax variations' },
            // { country: 'DE', iso3: 'DEU', name: 'Germany', worldTaxes: 1, totalTaxes: 45, comments: 'Progressive tax system' },
            // { country: 'FR', iso3: 'FRA', name: 'France', worldTaxes: 1, totalTaxes: 45, comments: 'Progressive tax system' },
            // { country: 'GB', iso3: 'GBR', name: 'United Kingdom', worldTaxes: 1, totalTaxes: 45, comments: 'Non-dom regime available' },
            // { country: 'MY', iso3: 'MYS', name: 'Malaysia', worldTaxes: 0, totalTaxes: 8, comments: 'Territorial tax system' },
            // { country: 'TH', iso3: 'THA', name: 'Thailand', worldTaxes: 0, totalTaxes: 5, comments: 'Recent changes to tax residency rules' },
            // { country: 'PH', iso3: 'PHL', name: 'Philippines', worldTaxes: 1, totalTaxes: 8, comments: 'Progressive tax system' },
            // { country: 'BG', iso3: 'BGR', name: 'Bulgaria', worldTaxes: 1, totalTaxes: 10, comments: 'Flat tax rate' },
            // { country: 'EE', iso3: 'EST', name: 'Estonia', worldTaxes: 1, totalTaxes: 0, comments: 'No tax on retained earnings' },
            // { country: 'CY', iso3: 'CYP', name: 'Cyprus', worldTaxes: 0, totalTaxes: 5, comments: 'Non-dom regime available' },
            // { country: 'MT', iso3: 'MLT', name: 'Malta', worldTaxes: 1, totalTaxes: 8, comments: 'Tax refund system available' },
            // { country: 'PA', iso3: 'PAN', name: 'Panama', worldTaxes: 0, totalTaxes: 7, comments: 'Territorial tax system' },
            // { country: 'CR', iso3: 'CRI', name: 'Costa Rica', worldTaxes: 0, totalTaxes: 8, comments: 'Territorial tax system' },
            // { country: 'UY', iso3: 'URY', name: 'Uruguay', worldTaxes: 0, totalTaxes: 7, comments: 'Tax benefits for new residents' }
        ];

        let map;
        let countryBoundaries = {};
        let countriesLayer;
        let currentLayers = {
            regular: null,
            terrain: null,
            satellite: null
        };
        let activeLayer = 'regular';

        // Create lookup objects for faster access
        const countryDataByISO2 = {};
        const countryDataByISO3 = {};
        const countryDataByName = {};

        // Build lookup tables
        countryData.forEach(country => {
            countryDataByISO2[country.country] = country;
            countryDataByISO3[country.iso3] = country;
            countryDataByName[country.name.toLowerCase()] = country;
        });

        function initMap() {
            // Initialize the map
            map = L.map('map').setView([20, 0], 2);

            // Define different tile layers
            currentLayers = {
                regular: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                }),
                terrain: L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}{r}.png', {
                    attribution: 'Map tiles by Stamen Design, CC BY 3.0 ‚Äî Map data ¬© OpenStreetMap contributors',
                    maxZoom: 18
                }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 18
                })
            };

            // Add default layer
            currentLayers.regular.addTo(map);

            // Load country boundaries
            loadCountryBoundaries();

            // Event listeners for switches
            document.getElementById('noTaxSwitch').addEventListener('change', updateOverlays);
            document.getElementById('lowTaxSwitch').addEventListener('change', updateOverlays);
        }

        async function loadCountryBoundaries() {
            try {
                // Load world countries GeoJSON from a reliable source
                const response = await fetch('countries-mini.geojson');
                const worldData = await response.json();

                // Create a layer group for countries
                countriesLayer = L.layerGroup().addTo(map);

                // Process each country feature
                worldData.features.forEach(feature => {
                    const iso2 = feature.properties.cca2.toUpperCase();
                    console.log(iso2);

                    // Try to find matching country data
                    let countryInfo = null;
                    if (iso2 && countryDataByISO2[iso2]) {
                        countryInfo = countryDataByISO2[iso2];
                    }

                    if (countryInfo) {
                        // Create the country polygon
                        const countryPolygon = L.geoJSON(feature, {
                            style: {
                                fillColor: 'transparent',
                                fillOpacity: 0,
                                color: 'transparent',
                                weight: 0,
                                opacity: 0
                            }
                        });

                        // Add popup and click events
                        const popupContent = `
                            <div>
                                <h3>${countryInfo.name}</h3>
                                <p><strong>World Taxes:</strong> ${countryInfo.worldTaxes ? 'Yes' : 'No'}</p>
                                <p><strong>Tax Rate:</strong> ${countryInfo.totalTaxes}%</p>
                                <p><strong>Comments:</strong> ${countryInfo.comments}</p>
                            </div>
                        `;

                        countryPolygon.bindPopup(popupContent);
                        
                        countryPolygon.on('click', function() {
                            showCountryInfo(countryInfo);
                        });

                        countryPolygon.on('mouseover', function(e) {
                            if (e.target.options.fillOpacity > 0) {
                                e.target.setStyle({
                                    weight: 3,
                                    opacity: 1
                                });
                            }
                        });

                        countryPolygon.on('mouseout', function(e) {
                            if (e.target.options.fillOpacity > 0) {
                                e.target.setStyle({
                                    weight: 2,
                                    opacity: 0.8
                                });
                            }
                        });

                        // Store the polygon
                        countryBoundaries[countryInfo.country] = countryPolygon;
                        countryPolygon.addTo(countriesLayer);
                    }
                });

                // Hide loading status
                document.getElementById('loadingStatus').classList.add('status-hidden');

            } catch (error) {
                console.error('Error loading country boundaries:', error);
                document.getElementById('loadingStatus').textContent = 'Failed to load boundaries. Using fallback mode.';
                
                // Fallback to the previous marker-based approach
                setTimeout(() => {
                    document.getElementById('loadingStatus').classList.add('status-hidden');
                }, 3000);
            }
        }

        function showCountryInfo(country) {
            const infoDiv = document.getElementById('countryInfo');
            const detailsDiv = document.getElementById('countryDetails');
            
            detailsDiv.innerHTML = `
                <p><strong>Country:</strong> ${country.name}</p>
                <p><strong>ISO Code:</strong> ${country.country}</p>
                <p><strong>World Taxes:</strong> ${country.worldTaxes ? 'Yes' : 'No'}</p>
                <p><strong>Tax Rate:</strong> ${country.totalTaxes}%</p>
                <p><strong>Comments:</strong> ${country.comments}</p>
            `;
            
            infoDiv.style.display = 'block';
        }

        function setMapType(type) {
            // Remove current layer
            Object.values(currentLayers).forEach(layer => {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });

            // Add new layer
            if (currentLayers[type]) {
                currentLayers[type].addTo(map);
                activeLayer = type;
            }

            // Update button states
            document.querySelectorAll('.map-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function updateOverlays() {
            const noTaxEnabled = document.getElementById('noTaxSwitch').checked;
            const lowTaxEnabled = document.getElementById('lowTaxSwitch').checked;

            // Reset all country styles
            Object.values(countryBoundaries).forEach(polygon => {
                polygon.setStyle({
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    color: 'transparent',
                    weight: 0,
                    opacity: 0
                });
            });

            // Apply styles based on criteria
            countryData.forEach(country => {
                const polygon = countryBoundaries[country.country];
                if (!polygon) return;

                let shouldShow = false;
                let color = '#ff0000';
                let fillColor = '#ff0000';

                // Check if country meets "No World Taxes" criteria
                if (noTaxEnabled && country.worldTaxes === 0) {
                    shouldShow = true;
                    color = '#4CAF50';
                    fillColor = '#4CAF50';
                }

                // Check if country meets "Low Tax" criteria
                if (lowTaxEnabled && country.totalTaxes <= 10) {
                    shouldShow = true;
                    color = '#2196F3';
                    fillColor = '#2196F3';
                }

                // If both conditions are met, prioritize green (no world taxes)
                if (noTaxEnabled && lowTaxEnabled && country.worldTaxes === 0 && country.totalTaxes < 10) {
                    color = '#4CAF50';
                    fillColor = '#4CAF50';
                }

                if (shouldShow) {
                    polygon.setStyle({
                        fillColor: fillColor,
                        fillOpacity: 0.8,
                        color: color,
                        weight: 2,
                        opacity: 0.8
                    });
                }
            });
        }

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
